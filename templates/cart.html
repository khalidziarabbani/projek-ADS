{% extends 'base.html' %}
{% block title %}Cart{% endblock title %}
{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/cart.css' %}">
{% include 'navbar.html' %}

<div class="bg">
    <h1>Cart</h1>
    <div class="total-box">
        <div class="prod">
            {% for item in items %}
            <div class="item">
                <a href="{% url 'product_detail' item.product.id %}">
                    <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
                </a>
                <div class="item-detail">
                    <p>{{ item.product.name }}</p>
                    <h3>${{item.get_total|floatformat:2}}</h3>
                </div>
                <div class="btn-item">
                    <button data-product="{{item.id}}" class="delete-btn updateItem" data-action="delete" ><img src="{% static 'img/trash.svg' %}" alt="del"></button>
                    <div class="item-quantity">
                        <button data-product="{{item.id}}" class="qty-btn updateItem" data-action="remove" >-</button>
                        <input id="qtyInput" class="qtyInput" type="text" min="1" value="{{item.quantity}}" readonly>
                        <button data-product="{{item.id}}" class="qty-btn updateItem" data-action="add" >+</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="summary">
            <h1>Shopping Summary</h1>
            <div class="summary-box">
                <div class="summary-detail">
                    <p>Total</p>
                    <p>${{ subtotal|floatformat:2 }}</p>
                </div>
                <a href="{% url 'delivery' %}">
                    <button type="submit">Buy</button>
                </a>
            </div>
        </div>
    </div>
    <div class="other-product">
        <h1>Let's Checkout Other Products</h1>
        <div class="product-container">
            {% for p in other_products %}
            <a href="{% url 'product_detail' p.id %}" class="product-box">
                <img src="{{ p.image.url }}" alt="{{ p.name }}">
                <h4>{{ p.name }}</h4>
                <div class="pay">
                    <p>${{ p.price }}</p>
                    <div class="btn">
                        <p>Add to Cart</p>
                        <img src="{% static 'img/cart-white.svg' %}" alt="cart">
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
</div>

{% include 'footer.html' %}

<script>
    var qtyInput = document.getElementById('qtyInput');
    
        function decreaseQty() {
        let currentValue = parseInt(qtyInput.value);
        if (currentValue > 1) {
            currentValue--;
            qtyInput.value = currentValue;
        }
        }
    
        function increaseQty() {
        let currentValue = parseInt(qtyInput.value);
        currentValue++;
        qtyInput.value = currentValue;
        }
</script>

<script>
    var update = document.getElementsByClassName('updateItem')
    for(var i = 0; i < update.length; i++){
        update[i].addEventListener('click', function(){
            var productId  = this.dataset.product
            var action = this.dataset.action
            console.log('productId:', productId, 'Action:', action)
            console.log('USER:', user)
            if(user == 'AnonymousUser'){
                console.log('Not logged in')
                alert('You need to login first to add items to your cart.')
            }else{
                updateUserOrder(productId, action)
            }
        })
    }

    function updateUserOrder(productId, action){
        console.log('User is logged in, sending data...')

        var url = '/updateItem/'

        fetch(url, {
            method:'POST',
            headers:{
                'Content-Type':'application/json',
                'X-CSRFToken':csrftoken,
            },
            body:JSON.stringify({'productId':productId, 'action':action})
        })

        .then((response) => {
            return response.json()
        })

        .then((response) => {
            console.log('data:', response)
            location.reload()
        })
    }
</script>

{% endblock content %}
